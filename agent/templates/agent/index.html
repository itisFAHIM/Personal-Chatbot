<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAHIM Code Korbi Agent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif; background: #1a1a1a; color: #e4e4e7; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .header { background: #2a2a2a; padding: 16px 24px; border-bottom: 1px solid #3a3a3a; display: flex; align-items: center; justify-content: space-between; }
        .header h1 { font-size: 20px; font-weight: 600; color: #fff; }
        .header-actions { display: flex; gap: 12px; }
        .btn-icon { background: transparent; border: none; color: #a1a1aa; cursor: pointer; padding: 8px; border-radius: 6px; transition: all 0.2s; }
        .btn-icon:hover { background: #3a3a3a; color: #fff; }
        .main-container { flex: 1; display: flex; overflow: hidden; }
        .sidebar { width: 260px; background: #252525; border-right: 1px solid #3a3a3a; display: flex; flex-direction: column; padding: 16px; }
        .new-chat-btn { background: #3b82f6; color: white; border: none; padding: 12px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; margin-bottom: 20px; transition: background 0.2s; }
        .new-chat-btn:hover { background: #2563eb; }
        .chat-history { flex: 1; overflow-y: auto; }
        .chat-history-item { padding: 10px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; color: #a1a1aa; margin-bottom: 4px; transition: all 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-history-item:hover { background: #3a3a3a; color: #fff; }
        .chat-history-item.active { background: #3a3a3a; color: #fff; }
        .chat-container { flex: 1; display: flex; flex-direction: column; max-width: 900px; margin: 0 auto; width: 100%; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 32px 24px; display: flex; flex-direction: column; gap: 24px; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 40px; }
        .empty-state h2 { font-size: 32px; margin-bottom: 16px; color: #fff; font-weight: 600; }
        .empty-state p { color: #a1a1aa; font-size: 16px; }
        .message { display: flex; gap: 16px; max-width: 100%; }
        .message-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        .user-avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .bot-avatar { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .message-content { flex: 1; line-height: 1.6; }
        .message-role { font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .user-message .message-role { color: #60a5fa; }
        .bot-message .message-role { color: #4ade80; }
        .message-text { color: #e4e4e7; font-size: 15px; }
        .message-text pre { background: #0d0d0d; padding: 16px; border-radius: 8px; overflow-x: auto; margin: 12px 0; border: 1px solid #2a2a2a; }
        .message-text code { background: #2a2a2a; padding: 2px 6px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 14px; }
        .message-text pre code { background: transparent; padding: 0; }
        .input-container { padding: 20px 24px; border-top: 1px solid #3a3a3a; background: #1a1a1a; }
        .input-wrapper { display: flex; gap: 12px; max-width: 900px; margin: 0 auto; background: #2a2a2a; border-radius: 12px; padding: 12px 16px; border: 1px solid #3a3a3a; transition: border-color 0.2s; }
        .input-wrapper:focus-within { border-color: #3b82f6; }
        #user-input { flex: 1; background: transparent; border: none; color: #fff; font-size: 15px; outline: none; font-family: inherit; }
        #user-input::placeholder { color: #71717a; }
        .send-btn { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: background 0.2s; }
        .send-btn:hover:not(:disabled) { background: #2563eb; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .typing-indicator { display: flex; gap: 4px; padding: 12px 0; }
        .typing-dot { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { opacity: 0.3; transform: translateY(0); } 30% { opacity: 1; transform: translateY(-10px); } }
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: #3a3a3a; border-radius: 4px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #4a4a4a; }
        .empty-history { text-align: center; color: #71717a; font-size: 13px; padding: 20px 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>FAHIM_Code_Korbi Agent</h1>
        <div class="header-actions">
    <button class="btn-icon" title="Settings">‚öôÔ∏è</button>
    <button class="btn-icon" title="Clear Chat" onclick="newChat()">üóëÔ∏è</button>

    <form action="{% url 'logout' %}" method="post" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn-icon" title="Sign Out" style="color: #f87171;">
            üö™
        </button>
    </form>
</div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <button class="new-chat-btn" onclick="newChat()">+ New Chat</button>
            <div class="chat-history" id="chat-history">
                <div class="empty-history">No chat history yet</div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="empty-state">
                    <h2>Where should we begin?</h2>
                    <p>Ask Korbi to help you code anything</p>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
    <input type="file" id="file-upload" style="display: none" onchange="handleFileUpload()">
    
    <button class="btn-icon" onclick="document.getElementById('file-upload').click()" title="Upload Code File">
        üìé
    </button>

    <input 
        type="text" 
        id="user-input" 
        placeholder="Ask Korbi to code something..."
        onkeypress="if(event.key === 'Enter') sendMessage()"
    >
    <button class="send-btn" onclick="sendMessage()">Send</button>
</div>

<div id="file-preview" style="display: none; padding: 10px; color: #4ade80; font-size: 13px;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        let uploadedFileContent = "";

function handleFileUpload() {
    const fileInput = document.getElementById('file-upload');
    const file = fileInput.files[0];
    const preview = document.getElementById('file-preview');

    if (file) {
        const reader = new FileReader();
        
        // When file is read, save its text
        reader.onload = function(e) {
            uploadedFileContent = `\n\n--- UPLOADED FILE: ${file.name} ---\n${e.target.result}\n----------------\n`;
            
            // Show preview
            preview.style.display = 'block';
            preview.innerText = `üìé Attached: ${file.name}`;
            preview.scrollIntoView();
        };
        
        reader.readAsText(file);
    }
}
        let currentSessionId = null;

        // Load chat sessions on page load
        window.addEventListener('DOMContentLoaded', loadChatSessions);

        async function loadChatSessions() {
            try {
                const response = await fetch('/api/sessions/');
                const data = await response.json();
                
                const historyContainer = document.getElementById('chat-history');
                
                if (data.sessions.length === 0) {
                    historyContainer.innerHTML = '<div class="empty-history">No chat history yet</div>';
                } else {
                    historyContainer.innerHTML = '';
                    data.sessions.forEach(session => {
                        const item = document.createElement('div');
                        item.className = 'chat-history-item';
                        item.textContent = session.title;
                        item.dataset.sessionId = session.session_id;
                        item.onclick = () => loadSession(session.session_id);
                        historyContainer.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        async function loadSession(sessionId) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/`);
                const data = await response.json();
                
                currentSessionId = sessionId;
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                
                // Mark active session in sidebar
                document.querySelectorAll('.chat-history-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.sessionId === sessionId) {
                        item.classList.add('active');
                    }
                });
                
                // Display messages
                data.messages.forEach(msg => {
                    addMessageToUI(msg.role, msg.content);
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error loading session:', error);
            }
        }

        function newChat() {
            currentSessionId = null;
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = `
                <div class="empty-state">
                    <h2>Where should we begin?</h2>
                    <p>Ask Korbi to help you code anything</p>
                </div>
            `;
            
            // Remove active class from all history items
            document.querySelectorAll('.chat-history-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        function addMessageToUI(role, content) {
            const chatMessages = document.getElementById('chat-messages');
            
            // Remove empty state if it exists
            const emptyState = chatMessages.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}-message`;
            
            const isUser = role === 'user';
            const formattedContent = isUser ? escapeHtml(content) : marked.parse(content);
            
            messageEl.innerHTML = `
                <div class="message-avatar ${role}-avatar">${isUser ? 'You' : 'K'}</div>
                <div class="message-content">
                    <div class="message-role">${isUser ? 'You' : 'Korbi'}</div>
                    <div class="message-text">${formattedContent}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageEl);
            
            if (!isUser) {
                // Highlight code blocks
                messageEl.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
        }

async function sendMessage() {
    const input = document.getElementById('user-input');
    const chatMessages = document.getElementById('chat-messages');
    let finalMessage = input.value.trim(); // Keep original for display

    // If there is a file, append it hiddenly to the message sent to backend
    let backendMessage = finalMessage;
    if (uploadedFileContent) {
        backendMessage += uploadedFileContent;
        // Clear the upload after sending
        uploadedFileContent = ""; 
        document.getElementById('file-preview').style.display = 'none';
        document.getElementById('file-upload').value = ""; // Reset input
    }

    if (!finalMessage && !uploadedFileContent) return; // Don't send empty

    // Add user message to UI
    addMessageToUI('user', finalMessage);

    input.value = '';
    input.disabled = true;
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Add typing indicator
    const typingEl = document.createElement('div');
    typingEl.className = 'message bot-message';
    typingEl.id = 'typing-indicator';
    typingEl.innerHTML = `
        <div class="message-avatar bot-avatar">K</div>
        <div class="message-content">
            <div class="message-role">Korbi</div>
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
    chatMessages.appendChild(typingEl);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
        const response = await fetch('/api/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                message: backendMessage,
                session_id: currentSessionId
            })
        });

        const data = await response.json();
        
        // Remove typing indicator
        document.getElementById('typing-indicator').remove();

        // Update current session ID
        currentSessionId = data.session_id;

        // Add bot response
        addMessageToUI('assistant', data.response);
        
        // Reload chat sessions to update sidebar
        await loadChatSessions();
        
        // Mark current session as active
        document.querySelectorAll('.chat-history-item').forEach(item => {
            if (item.dataset.sessionId === currentSessionId) {
                item.classList.add('active');
            }
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (error) {
        const typing = document.getElementById('typing-indicator');
        if (typing) typing.remove();

        const errorEl = document.createElement('div');
        errorEl.className = 'message bot-message';
        errorEl.innerHTML = `
            <div class="message-avatar bot-avatar">K</div>
            <div class="message-content">
                <div class="message-role">Korbi</div>
                <div class="message-text" style="color: #f87171;">
                    Sorry, I encountered an error: ${error.message}
                </div>
            </div>
        `;
        chatMessages.appendChild(errorEl);
    } finally {
        input.disabled = false;
        input.focus();
    }
}

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
    </script>
</body>
</html>